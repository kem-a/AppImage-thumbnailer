#!/bin/bash
inFile="$(realpath "$1")"
outFile="$(realpath -m "$2")"
size="$3"

# Extract .DirIcon from AppImage
echo "Extracting .DirIcon from AppImage..."
thumb=$(7z e -so "$inFile" '.DirIcon' 2>/dev/null)

if [[ -z "$thumb" ]]; then
  echo "Failed to extract .DirIcon from AppImage."
  exit 1
fi

while true; do
  echo "Testing icon: $thumb"
  # Extract the icon file to check if it's a symlink or actual image
  icon_data=$(7z e -so "$inFile" "$thumb" | base64)
  
  if [[ -n "$icon_data" ]]; then
    echo "Icon found: $thumb"
    echo "$icon_data" | base64 -d | magick - -background none -resize "$size" "$outFile"
    if [[ $? -ne 0 ]]; then
      echo "Failed to create thumbnail using ImageMagick."
      exit 1
    fi
    break
  elif [[ -L "$thumb" ]]; then
    thumb_path=$(7z e -so "$inFile" "$thumb" 2>/dev/null | readlink -f)
    thumb="$thumb_path"
  else
    echo "Icon file not found: $thumb"
    exit 1
  fi
done

echo "Thumbnail created successfully and saved to $outFile"